# 分支节点移动功能说明

## 概述

分支节点移动功能允许用户在故事板中重新排列节点，同时保持分支结构的完整性。该功能通过 `BranchUtils.canMoveToPosition()` 函数来验证移动操作的有效性。

## 节点类型

### 1. 主线节点 (Main Node)
- 普通的故事分镜节点
- 可以自由移动，不受分支结构限制

### 2. 探索节点 (Exploration Node)
- 用于探索新情景的特殊节点
- 包含 `explorationData.isExplorationNode: true` 标识
- 不能移动，保持固定位置

### 3. 分支节点 (Branch Node)
- 从探索节点生成的第一层分支
- 包含 `branchData` 属性
- 移动限制：
  - 不能移动到探索节点之前
  - 只能在同组分支节点范围内移动
  - 保持分支的相对顺序

### 4. 分支子节点 (Branch Child Node)
- 分支节点下的子分镜
- 包含 `parentBranchId` 属性
- 移动限制：
  - 只能在同一分支内移动
  - 不能移动到其他分支或主线节点之后
  - 保持分支内的相对顺序

## 移动规则

### 分支节点移动规则
1. **不能移动到探索节点之前**：分支节点必须保持在探索节点之后
2. **同组分支范围限制**：只能在同组分支节点之间移动
3. **相对顺序保持**：移动后保持分支的相对顺序

### 分支子节点移动规则
1. **同分支限制**：只能在同一个分支内移动
2. **不能跨分支**：不能移动到其他分支节点之后
3. **不能到主线**：不能移动到主线节点之后

### 主线节点移动规则
1. **自由移动**：可以在主线节点之间自由移动
2. **不影响分支**：移动不会影响分支结构

## 使用示例

```javascript
// 检查节点是否可以移动到指定位置
const canMove = BranchUtils.canMoveToPosition(storyData, node, targetIndex);

if (canMove) {
  // 执行移动操作
  handleMoveNode(nodeId, direction);
} else {
  // 显示错误提示
  console.log('无法移动分支节点到目标位置');
}
```

## 实现细节

### 移动验证逻辑
1. **边界检查**：确保目标位置在有效范围内
2. **节点类型识别**：根据节点属性判断节点类型
3. **分支关系验证**：检查移动是否会影响分支结构
4. **顺序约束检查**：确保移动后保持合理的顺序

### 错误处理
- 当移动操作被拒绝时，节点保持原位置不变
- 在控制台输出详细的错误信息
- 用户界面可以显示相应的提示信息

## 注意事项

1. **分支完整性**：移动操作必须保持分支结构的完整性
2. **连接关系**：移动后需要重新计算节点间的连接关系
3. **视觉布局**：移动后需要重新排布节点的视觉位置
4. **性能考虑**：大量节点移动时需要考虑性能优化

## 未来改进

1. **拖拽移动**：支持鼠标拖拽移动节点
2. **批量移动**：支持同时移动多个相关节点
3. **撤销功能**：支持移动操作的撤销和重做
4. **动画效果**：添加移动时的平滑动画效果 