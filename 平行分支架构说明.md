# 平行分支架构功能说明

## 概述

平行分支架构是StoryFlow系统中的一个重要功能，允许用户在故事创作过程中创建多个平行的故事分支，每个分支代表不同的情节发展方向。

## 主要功能

### 1. 探索节点创建
- 在主线故事的任何位置，用户可以创建探索节点
- 探索节点用于收集用户的想法和探索方向
- 支持拖拽关键词气泡到探索区域

### 2. 分支生成
- 基于探索节点的内容，系统可以生成多个平行的故事分支
- 每个分支代表不同的情节发展方向
- 分支节点会自动分配到不同的水平线上，实现平行布局

### 3. 平行布局
- 主线故事保持在中央水平线上
- 分支故事在平行的水平线上展开
- 每个分支水平线可以包含多个连续的节点
- 分支之间保持适当的垂直间距

### 4. 分支标识
- 每个分支节点都有明确的分支标识
- 显示"分支 1"、"分支 2"等标识
- 使用蓝色圆点图标区分分支节点

### 5. 连接线样式
- **主线连接**：灰色实线，表示主线故事的发展
- **分支连接**：蓝色虚线，从探索节点指向分支节点
- **分支内连接**：绿色实线，表示同一分支内节点的连接

### 6. 分支合并
- 用户可以将分支内容合并回主线
- 合并时会保留分支节点的文本内容
- 探索节点和分支节点会被移除
- 主线故事继续发展

## 使用方法

### 创建探索节点
1. 在主线故事中选择一个节点
2. 点击"探索场景"按钮
3. 在探索节点中输入探索内容
4. 可以拖拽关键词气泡到探索区域

### 生成分支
1. 在探索节点中输入探索内容
2. 点击"情景构思"按钮
3. 系统会生成多个分支选项
4. 选择合适的分支进行创建

### 管理分支
1. 分支节点会自动布局在平行水平线上
2. 可以在分支内继续添加节点
3. 分支节点会显示分支标识

### 合并分支
1. 在探索节点上点击"合并分支"按钮
2. 系统会将分支内容合并到主线
3. 探索节点和分支节点会被移除
4. 主线故事继续发展

## 技术实现

### 数据结构
```javascript
// 探索节点
{
  id: "exploration_123",
  explorationData: {
    isExplorationNode: true,
    explorationText: "探索内容",
    bubbleData: [...]
  }
}

// 分支节点
{
  id: "frame_456",
  branchData: {
    branchId: "branch_exploration_123_0_1234567890",
    parentNodeId: "exploration_123",
    branchIndex: 0,
    branchLineIndex: 0
  }
}
```

### 布局算法
1. 识别主线和分支节点
2. 计算分支水平线数量
3. 为每个分支分配水平线索引
4. 在各自水平线上布局节点
5. 计算连接关系

### 连接渲染
1. 主线连接：从左到右的曲线
2. 分支连接：从探索节点到分支节点的虚线
3. 分支内连接：同一水平线上的直线

## 优势

1. **灵活性**：支持多种故事发展方向
2. **可视化**：清晰的平行布局展示
3. **可管理**：支持分支的创建、发展和合并
4. **用户友好**：直观的界面和操作方式

## 注意事项

1. 分支节点不能直接连接到主线节点
2. 合并分支会丢失分支的独立发展
3. 建议在合并前备份重要的分支内容
4. 分支数量过多可能影响布局效果 