# 连接式分支架构功能说明

## 概述

连接式分支架构是StoryFlow系统中的一个重要功能，允许用户在故事创作过程中创建多个分支，每个分支都与探索节点保持连接关系，同时分支内的节点也保持连接。

## 主要功能

### 1. 探索节点创建
- 在主线故事的任何位置，用户可以创建探索节点
- 探索节点用于收集用户的想法和探索方向
- 支持拖拽关键词气泡到探索区域

### 2. 连接式分支生成
- 基于探索节点的内容，系统可以生成多个故事分支
- 探索节点连接到由其创建的所有分支节点
- 分支节点可以继续创建新的探索节点和分支

### 3. 平行布局
- 主线故事保持在中央水平线上
- 分支故事在平行的水平线上展开
- 每个分支水平线可以包含多个连续的节点
- 分支之间保持适当的垂直间距

### 4. 分支标识
- 每个分支节点都有明确的分支标识
- 显示"分支 1"、"分支 2"等标识
- 使用蓝色圆点图标区分分支节点

### 5. 连接线样式
- **探索到分支连接**：蓝色虚线，表示从探索节点到分支节点的连接
- **分支内连接**：绿色实线，表示同一分支内节点的连接
- **主线连接**：灰色实线，表示主线故事的发展

### 6. 独立发展
- 每个分支节点都可以调出情境探索面板
- 分支节点可以继续创建新的分支
- 每个分支都是独立的故事线

## 使用方法

### 创建探索节点
1. 在主线故事中选择一个节点
2. 点击"探索场景"按钮
3. 在探索节点中输入探索内容
4. 可以拖拽关键词气泡到探索区域

### 生成连接式分支
1. 在探索节点中输入探索内容
2. 点击"情景构思"按钮
3. 系统会生成多个分支选项
4. 选择合适的分支进行创建
5. 探索节点会自动连接到所有创建的分支节点

### 管理分支
1. 分支节点会自动布局在平行水平线上
2. 可以在分支内继续添加节点
3. 分支节点会显示分支标识
4. 每个分支节点都可以继续创建新的探索节点

### 分支独立发展
1. 点击任何分支节点
2. 使用"情景探索"功能创建新的探索节点
3. 新创建的探索节点属于该分支
4. 可以继续生成新的分支

## 技术实现

### 数据结构
```javascript
// 探索节点
{
  id: "exploration_123",
  explorationData: {
    isExplorationNode: true,
    explorationText: "探索内容",
    bubbleData: [...]
  },
  connections: ["frame_456", "frame_789"] // 连接到由其创建的分支节点
}

// 连接式分支节点
{
  id: "frame_456",
  branchData: {
    branchId: "branch_exploration_123_0_1234567890",
    parentNodeId: "exploration_123", // 记录创建它的探索节点
    explorationText: "探索内容",
    bubbleData: [...],
    branchIndex: 0,
    branchLineIndex: 0,
    isIndependent: true // 标记为独立节点
  },
  connections: ["frame_789"] // 连接到同一分支内的下一个节点
}
```

### 布局算法
1. 识别主线和分支节点
2. 计算分支水平线数量
3. 为每个分支分配水平线索引
4. 在各自水平线上布局节点
5. 计算连接关系（探索节点连接分支节点，分支内节点连接）

### 连接渲染
1. **探索到分支连接**：蓝色虚线，从探索节点指向分支节点
2. **分支内连接**：绿色实线，同一水平线上的直线
3. **主线连接**：灰色实线，从左到右的曲线

## 优势

1. **连接性**：探索节点与分支节点保持明确的连接关系
2. **顺序性**：同一分支内的节点保持连接，表示顺序关系
3. **灵活性**：支持无限的分支嵌套和扩展
4. **清晰性**：明确的视觉分离和连接标识
5. **可扩展性**：每个分支都可以继续创建新的分支

## 注意事项

1. 探索节点连接到由其创建的所有分支节点
2. 同一分支内的节点保持连接关系
3. 每个分支节点都可以继续创建新的探索节点
4. 分支的独立性使得故事结构更加灵活
5. 建议合理控制分支数量，避免过于复杂的结构

## 与之前版本的区别

### 新增的功能
- 探索节点连接到由其创建的分支节点
- 同一分支内的节点保持连接关系
- 更清晰的连接线样式区分

### 改进的功能
- 更明确的连接关系
- 更好的视觉层次
- 更直观的故事结构

### 保持的功能
- 分支节点完全独立
- 每个分支节点都可以继续创建新的探索节点
- 支持无限的分支嵌套

## 连接关系说明

### 探索节点连接
- 探索节点连接到由其创建的所有分支节点
- 使用蓝色虚线表示这种连接关系
- 连接线从探索节点右侧指向分支节点左侧

### 分支内连接
- 同一分支内的节点保持水平连接
- 使用绿色实线表示这种连接关系
- 连接线从左到右，表示故事发展顺序

### 主线连接
- 主线节点之间的连接
- 使用灰色实线表示这种连接关系
- 连接线从左到右，表示主线故事发展 